# Deployment Guide - ML Service v2

## Overview

This is a completely new ML service built from scratch following all best practices documentation. It maintains gRPC compatibility with the existing NestJS API.

## Quick Start

### Option 1: Use New Service (Recommended)

Update `docker-compose.yml` to point to the new service, or use `docker-compose.v2.yml`:

```bash
# Use the v2 compose file
docker-compose -f docker-compose.v2.yml up --build

# Or update GRPC_ML_SERVICE_URL in docker-compose.yml to point to python-ml-v2
```

### Option 2: Run Alongside Old Service (Testing)

Both services can run simultaneously on different ports:
- Old service: `python-ml` on port `50051`
- New service: `python-ml-v2` on port `50052`

Update NestJS API `GRPC_ML_SERVICE_URL` environment variable to switch between them.

## Building the Service

```bash
cd backend-python-ml-v2
docker build -t video-translation-ml-v2 .
```

## Configuration

Configuration is managed via:
1. `src/config/config.yaml` - Default configuration
2. Environment variables - Override YAML settings

Key environment variables:
- `UPLOADS_DIR` - Uploads directory path
- `ARTIFACTS_DIR` - Artifacts directory path
- `TEMP_WORK_DIR` - Temporary work directory
- `GRPC_PORT` - gRPC server port (default: 50051)
- `MAX_MEMORY_GB` - Maximum memory limit
- `ENABLE_TRACING` - Enable OpenTelemetry tracing
- `TRACING_ENDPOINT` - OTLP endpoint for tracing

## Proto File Generation

Proto files are automatically generated by the entrypoint script. If you need to generate them manually:

```bash
cd backend-python-ml-v2
./generate_proto.sh
```

Or in Docker:
```bash
docker exec -it <container> python3 -m grpc_tools.protoc \
    -I./src/proto \
    --python_out=./src/proto \
    --grpc_python_out=./src/proto \
    --pyi_out=./src/proto \
    ./src/proto/translation.proto
```

## Testing

```bash
# Run unit tests
cd backend-python-ml-v2
pytest tests/unit/

# Run integration tests
pytest tests/integration/

# Run E2E tests
pytest tests/e2e/
```

## Integration with NestJS API

The new service maintains full gRPC compatibility with the existing NestJS API. No changes are required to the NestJS service.

To switch NestJS to use the new service:
1. Update `GRPC_ML_SERVICE_URL` environment variable to `python-ml-v2:50051`
2. Restart NestJS service

## Best Practices Documentation

All implementation follows the best practices in `../best-practices/`:
- Architecture patterns
- Design principles
- Stage-specific implementations
- Cross-cutting concerns
- Modern 2025 practices

## Troubleshooting

### Proto Import Errors
- Ensure proto files are generated (entrypoint script handles this)
- Check that `grpc-tools` is installed

### Memory Issues
- Adjust `MAX_MEMORY_GB` environment variable
- Model manager will automatically unload unused models

### Resource Exhaustion
- Resource manager monitors and logs warnings
- Check logs for resource health status

## Next Steps

1. Generate proto files (automatic on startup)
2. Test service startup
3. Test with NestJS API
4. Write comprehensive tests
5. Deploy to production



